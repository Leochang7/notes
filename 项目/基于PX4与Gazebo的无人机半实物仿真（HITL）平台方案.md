## 1. 引言
本系统为一套**无人机半实物仿真平台（Hardware-in-the-Loop Simulation, HIL）**，用于在实机试飞前，对无人机飞行控制系统进行功能验证与系统级测试。  
该平台通过引入真实飞控硬件，结合计算机仿真的飞行动力学模型、传感器模型与环境模型，在实验室条件下构建无人机飞行的闭环仿真环境。
与纯软件仿真相比，该系统能够真实反映飞控硬件在实时调度、接口通信和控制逻辑方面的运行特性；与实机试飞相比，系统具有安全性高、成本低、可重复性强等优点，是无人机研制过程中重要的过渡验证手段。
## 2. 基本原理
为深入理解本方案的技术核心，本章节将讲述半实物仿真（HITL）的工作机制，并着重分析其相较于纯软件仿真的优势。
HITL的核心原理在于构建一个虚实结合的闭环控制系统。在该模式下，真实的飞控硬件（如Pixhawk）及其上运行的完整PX4固件被无缝集成到仿真回路之中。与此同时，无人机的动力学模型、机载传感器（如IMU、GPS）以及复杂的外部飞行环境（如大气、地形）则由运行在开发计算机上的Gazebo物理仿真软件进行高保真度模拟。
这个实时闭环仿真回路中的数据流遵循以下步骤：
1. **模拟到物理 (Sim-to-Physical):** Gazebo中的虚拟无人机模型根据其内部的物理引擎解算出实时的飞行状态（如姿态、位置、速度），并据此生成模拟的传感器测量数据。
2. **数据传输:** 这些模拟的传感器数据通过USB或串口以高频率实时发送给物理飞控硬件。
3. **物理处理 (Physical Processing):** 物理飞控板上的PX4固件接收到这些仿真数据，并将其视为真实传感器的输入。固件内部完整的状态估计、导航滤波和飞行控制律算法开始处理这些数据，最终计算出驱动电机或舵机的控制指令。
4. **物理到模拟 (Physical-to-Sim):** 飞控硬件产生的PWM或其它形式的控制指令，被运行在Gazebo中的**MAVLink插件**所截获，并被**转换为对虚拟无人机模型施加的力和力矩**，回传给仿真环境。
5. **回路闭合:** Gazebo接收到这些控制指令后，将其施加于虚拟无人机模型上，从而更新其飞行状态。这就完成了一个完整的、实时的闭环控制仿真周期，并为下一个周期的开始做好了准备。
![image.png](https://raw.githubusercontent.com/Leochang7/imgGallery/main/img/20260111134234566.png)

<center>图1 HITL基本工作原理流程图</center>
HITL相对于SITL的根本优势在于：它能够在不进行任何实际飞行的条件下，全面测试运行在真实处理器上的完整固件代码。这种方式不仅验证了算法逻辑，更能暴露因处理器性能、时序问题、驱动程序缺陷等软硬件结合而产生的潜在问题，其测试结果更贴近真实飞行表现。

## 3. 系统架构设计
本章节将从总体架构、硬件组成和软件构成三个层面，详细剖析所提议的半实物仿真平台的具体设计，以确保系统的稳定性、功能完备性与可扩展性。
### 3.1 总体架构
本平台采用成熟的分布式设计，主要由**仿真与开发主机**、**飞控硬件实物**以及**地面监控站软件**三大部分构成。这三个核心部分通过标准化的通信接口（USB/UART和UDP）紧密耦合，形成一个功能完整、数据流畅的测试验证闭环。该分布式架构的优势在于将物理飞控硬件（被测对象）与仿真环境（测试平台）完全解耦，使得对飞控固件的测试成为一个独立的‘黑盒’验证过程，极大地提升了测试的模块化程度与结果的可信度。

![image.png](https://raw.githubusercontent.com/Leochang7/imgGallery/main/img/20260111134336512.png)
<center>图2 系统总体架构图</center>

### 3.2硬件组成
硬件是平台稳定运行的基石，其选择直接关系到仿真的可靠性与流畅度。以下是构建该平台所需的硬件设备清单：

| **组件**          | **规格建议**                                     | **功能说明**                                                |
| --------------- | -------------------------------------------- | ------------------------------------------------------- |
| 飞控硬件            | PX4飞控板                                       | 运行完整 PX4 飞控固件，负责状态估计、姿态控制、位置控制和飞行模式管理，在半实物仿真中参与闭环控制     |
| 开发与仿真主机         | 具备良好图形处理能力的Linux主机（推荐Ubuntu 20.04/22.04 LTS） | 用于运行高保真度的Gazebo物理仿真环境、QGroundControl地面站软件以及PX4固件的编译工具链。 |
| 连接线缆            | USB数据线                                       | 连接飞控与主机，传输 MAVLink 数据并用于配置/刷机                           |
| 稳压电源 / USB 供电模块 | 为飞控硬件提供稳定电源，保证仿真过程中的可靠运行                     | 固定飞控及相关连接设备，避免调试过程中因误操作造成设备移动或损坏                        |
| 物理支持            | 实验台/固定支架                                     | 用于部署高层导航或指控算法，与飞控及开发主机进行数据交互                            |
| 机载计算平台（可选）      | RK3588、Jetson Orin 等                         | 用于部署高层导航或指控算法，与飞控及开发主机进行数据交互                            |
| 网络通信设备（可选）      | 以太网 / Wi-Fi                                  | 支持多设备间的数据通信，如算法节点远程运行或状态转发                              |
| 显示设备（可选）        | 显示器                                          | 显示 Gazebo 仿真画面、QGroundControl 界面及 ROS 可视化信息             |
### 3.3 软件组成
软件系统是半实物仿真平台正常运行的关键组成部分，负责完成飞行控制逻辑、物理环境建模以及人机交互等功能。本平台基于一套成熟、稳定的开源软件工具构建，相关组件在无人机仿真与工程实践中已得到广泛应用，能够满足仿真精度和系统扩展性的要求。
（1）PX4 飞控固件
PX4 飞控固件运行于飞控硬件之上，是无人机飞行控制系统的核心软件。其内部集成了状态估计、姿态控制、位置控制以及飞行模式与任务管理等功能模块。在硬件在环仿真（HITL）模式下，PX4 固件不再依赖真实传感器输入，而是接收来自仿真环境生成的虚拟传感器数据，并按照真实飞行状态运行完整的飞控逻辑。
（2）Gazebo 仿真环境
Gazebo 是一款开源的三维物理仿真平台，用于构建无人机的虚拟飞行环境。在本系统中，Gazebo 负责对无人机六自由度动力学模型进行实时仿真，并生成对应的传感器数据，包括惯性测量、位置和航向等信息。同时，Gazebo 可模拟重力、风场等外部环境因素，为飞控提供接近真实飞行条件的输入数据。
![image.png](https://raw.githubusercontent.com/Leochang7/imgGallery/main/img/20260111140554253.png)

（3）QGroundControl（QGC）地面站软件
QGroundControl 是用于无人机配置与监控的地面站软件，为用户提供图形化操作界面。在半实物仿真过程中，QGC 主要用于飞控固件烧录、参数配置、仿真状态监控以及飞行任务的规划与管理。通过地面站，用户可以直观地查看虚拟无人机的姿态、位置和飞行状态，并对飞控参数进行调整。
上述软件组件相互配合，构成了完整的仿真运行环境。其中，PX4 负责飞行控制决策，Gazebo 负责飞行器与环境建模，QGroundControl 提供人机交互与系统管理功能，共同支撑半实物仿真平台的正常运行。
![image.png](https://raw.githubusercontent.com/Leochang7/imgGallery/main/img/20260111140603273.png)

## 4. 平台核心功能
（1）飞行控制律验证与参数在线调优
平台可在 HITL 闭环条件下对姿态环、速度环与位置环控制律进行验证，并配合地面站对关键状态量进行实时观测与分析。仿真运行时，Gazebo 生成的高频传感器数据驱动飞控完成状态估计与控制计算，QGroundControl 可同步显示俯仰、滚转、偏航等响应曲线，便于对比指令与实际响应之间的跟随误差，从而在实验室环境内完成 PID 参数的迭代整定与鲁棒性评估。
（2）全流程的自主飞行任务测试平台
完整支持从任务规划到任务执行的全流程闭环仿真测试。用户可以在QGC的地图界面上方便地规划复杂的航点（Waypoint）任务、勘测航线或其它自主飞行模式，然后一键上传至仿真回路中的PX4固件。随后，即可在虚拟环境中观察无人机是否能够精确、可靠地执行预定任务，全面验证其导航逻辑、任务切换和路径跟踪能力。
（3）关键故障模式与应急策略演练
这是该平台最具价值的应用之一。开发者可以在零风险、零成本的条件下，主动注入各种极端或危险的故障信号，例如模拟GPS信号丢失、IMU数据漂移、气压计数据突变、电池电压异常触发低电量保护、乃至单个电机失效后的姿态控制稳定性等。这使得验证飞控固件的故障保护（Failsafe）逻辑成为可能，确保在真实飞行中遇到突发状况时，无人机能够按预期触发相应的应急策略（如悬停、返航、降落），从而保障飞行安全。 
## 5. 实施方案
为确保 PX4 + Gazebo 半实物仿真平台能顺利搭建、稳定运行，并具备可复现性，我们将平台搭建过程分为四个逻辑清晰的阶段：环境初始化、硬件配置、模型联调与集成测试、全系统运行验证。这样的分阶段部署不仅便于逐步排查问题，也能减少部署过程中出现的意外情况。
（1）基础开发环境与硬件准备
首先在开发计算机上安装 Ubuntu 桌面操作系统。综合兼容性和稳定性考虑，推荐使用 Ubuntu 20.04 或 22.04 LTS 版本。操作系统安装完成后，按照 PX4 官方开发指南，配置 PX4 的开发与编译环境，并完成 Gazebo 仿真器和 QGroundControl 地面站软件的安装。
（2）飞控硬件接入与固件配置
在完成软件环境配置后，将 PX4 飞控硬件通过 USB 数据线连接至开发计算机，并启动 QGroundControl 地面站。确认地面站能够正确识别飞控后，为其烧录 PX4 的稳定版本固件。  
固件烧录完成后，需要在地面站中将飞控切换至硬件在环仿真模式。在参数设置页面中启用 HITL 相关选项，使飞控在后续运行中接收来自仿真系统的传感器数据。
（3）仿真模型准备与通信配置
在 PX4 源码目录中，选择与所使用机型对应的 Gazebo 仿真模型文件。通过修改模型文件中与 MAVLink 通信相关的配置参数，使仿真系统能够通过串口与飞控硬件建立通信连接。  
在该阶段，需要重点确认仿真模型中已启用硬件在环仿真模式，并且串口设备名称与实际连接的飞控接口保持一致，从而保证仿真数据能够正确发送至飞控。
（4）仿真模型准备与通信配置
完成前述配置后，依次启动 Gazebo 仿真环境和 QGroundControl 地面站。若配置正确，地面站将能够实时接收到来自仿真系统的飞行状态信息，包括姿态、位置和传感器数据等。  
当虚拟无人机在地面站中表现出正常的飞行状态时，说明半实物仿真平台已成功搭建，可以进一步开展控制参数调整和仿真测试工作。
![Gemini_Generated_Image_69p59p69p59p69p5.png](https://raw.githubusercontent.com/Leochang7/imgGallery/main/img/Gemini_Generated_Image_69p59p69p59p69p5.png)
